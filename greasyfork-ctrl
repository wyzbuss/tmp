// ==UserScript==
// @name         å…¨ç½‘æ‘¸é±¼åŠ©æ‰‹ (Boss Key) - çœŸå®ä¸šåŠ¡ç•Œé¢ç‰ˆ
// @name:en      Global Boss Key - Fake Interface (API Docs/Monitor)
// @namespace    http://tampermonkey.net/
// @version      1.0.0
// @description  åŒå‡»Ctrlé”®ï¼Œç¬é—´æ˜¾ç¤ºå…¨å±çš„çœŸå®ä¼ä¸šçº§æ¥å£æ–‡æ¡£ï¼ˆAPI Referenceï¼‰ï¼Œå¸¦å·¦ä¾§èœå•è”åŠ¨ã€è‡ªåŠ¨æŠ¢ç„¦ç‚¹ã€æ— æ„ŸçŸ¥äº¤äº’ã€‚æ”¯æŒè‡ªå®šä¹‰æ ‡é¢˜ï¼Œé€‚åˆç¨‹åºå‘˜æ‘¸é±¼ä½¿ç”¨ã€‚
// @description:en Double-click Ctrl to show a realistic enterprise API documentation (Swagger/Knife4j) overlay. Includes 8 business modules, auto-focus, and semantic data.
// @author       MoyuMaster
// @match        *://*/*
// @grant        none
// @license      MIT
// @keywords     æ‘¸é±¼, boss key, ä¼ªè£…, æ¥å£æ–‡æ¡£, swagger, knife4j
// @run-at       document-start
// ==/UserScript==

(function() {
    'use strict';

    // è¿™æ˜¯ä¸€ä¸ªæ‘¸é±¼è„šæœ¬ï¼ŒConsoleæ—¥å¿—å·²é™é»˜
    // console.log("ğŸ”¥ ç”Ÿäº§ç¯å¢ƒæ–‡æ¡£ v11.0 (Safe Mode) åŠ è½½ä¸­...");

    let overlay = null;

    // ========================================================================
    // ğŸ›¡ï¸ å®‰å…¨ç­–ç•¥ï¼šæ¸©å’Œçš„ç„¦ç‚¹ç®¡ç†
    // ========================================================================
    function safeFocus() {
        const active = document.activeElement;
        const isInput = active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable;
        
        if (!isInput && document.body) {
            if (!document.body.getAttribute('tabindex')) {
                document.body.setAttribute('tabindex', '-1');
                document.body.style.outline = 'none';
            }
            if (active === document.body) return;
            document.body.focus();
        }
    }

    window.addEventListener('load', safeFocus);
    window.addEventListener('mousemove', safeFocus, { once: true });

    // ========================================================================
    // 1. ä¸šåŠ¡é…ç½®
    // ========================================================================
    const MODULES = [
        { 
            id: "ums", name: "ç”¨æˆ·ä¸­å¿ƒ (User)", prefix: "/ums", 
            nouns: ["user", "role", "menu", "dept", "log"],
            fields: { str: "username", num: "userId", date: "lastLoginTime" }
        },
        { 
            id: "oms", name: "è®¢å•ç®¡ç† (Order)", prefix: "/oms", 
            nouns: ["order", "cart", "return", "invoice", "setting"],
            fields: { str: "orderNo", num: "payAmount", date: "createTime" }
        },
        { 
            id: "pms", name: "å•†å“ä¸­å¿ƒ (Product)", prefix: "/pms", 
            nouns: ["spu", "sku", "brand", "category", "attr"],
            fields: { str: "productName", num: "price", date: "publishTime" }
        },
        { 
            id: "sms", name: "è¥é”€ä¸­å¿ƒ (Marketing)", prefix: "/sms", 
            nouns: ["coupon", "flash", "advertise", "topic"],
            fields: { str: "activityName", num: "discount", date: "endTime" }
        },
        { 
            id: "pay", name: "æ”¯ä»˜ç½‘å…³ (Payment)", prefix: "/pay", 
            nouns: ["channel", "flow", "refund", "config"],
            fields: { str: "tradeNo", num: "totalFee", date: "payTime" }
        },
        { 
            id: "wms", name: "åº“å­˜ç®¡ç† (Warehouse)", prefix: "/wms", 
            nouns: ["stock", "warehouse", "delivery", "check"],
            fields: { str: "batchNo", num: "stockNum", date: "inTime" }
        },
        { 
            id: "rpt", name: "æ•°æ®æŠ¥è¡¨ (Report)", prefix: "/report", 
            nouns: ["daily", "monthly", "sales", "user_analysis"],
            fields: { str: "reportName", num: "statValue", date: "statDate" }
        },
        { 
            id: "mon", name: "ç³»ç»Ÿç›‘æ§ (Monitor)", prefix: "/actuator", 
            nouns: ["server", "redis", "jvm", "job"],
            fields: { str: "metric", num: "value", date: "timestamp" }
        }
    ];

    const ACTIONS = [
        { suffix: "page", method: "GET", desc: "åˆ†é¡µæŸ¥è¯¢åˆ—è¡¨", type: "list" },
        { suffix: "list", method: "GET", desc: "æŸ¥è¯¢å…¨éƒ¨æ•°æ®", type: "list" },
        { suffix: "info", method: "GET", desc: "è·å–è¯¦ç»†ä¿¡æ¯", type: "detail" },
        { suffix: "detail", method: "GET", desc: "æŸ¥è¯¢è¯¦æƒ…", type: "detail" },
        { suffix: "check", method: "GET", desc: "æ•°æ®æ ¡éªŒ", type: "detail" },
        { suffix: "tree", method: "GET", desc: "è·å–æ ‘å½¢ç»“æ„", type: "list" },
        { suffix: "options", method: "GET", desc: "è·å–ä¸‹æ‹‰é€‰é¡¹", type: "list" },
        { suffix: "create", method: "POST", desc: "æ–°å¢æ•°æ®", type: "form" },
        { suffix: "update", method: "POST", desc: "æ›´æ–°æ•°æ®", type: "form" },
        { suffix: "save", method: "POST", desc: "ä¿å­˜è‰ç¨¿", type: "form" },
        { suffix: "status", method: "POST", desc: "ä¿®æ”¹çŠ¶æ€", type: "form" },
        { suffix: "audit", method: "POST", desc: "å®¡æ ¸é€šè¿‡", type: "form" },
        { suffix: "remove", method: "DELETE", desc: "é€»è¾‘åˆ é™¤", type: "form" }
    ];

    // ========================================================================
    // 2. å†…å®¹ç”Ÿæˆå™¨
    // ========================================================================
    function generateResponse(moduleConfig, actionType) {
        const f = moduleConfig.fields;
        if (actionType === 'list') {
            return `{
  "code": 200,
  "msg": "success",
  "data": {
    "total": ${Math.floor(Math.random() * 5000) + 100},
    "size": 20,
    "current": 1,
    "records": [
      {
        "id": 10001,
        "${f.str}": "TEST_DATA_001",
        "${f.num}": ${Math.floor(Math.random() * 1000)},
        "status": 1,
        "${f.date}": "2026-01-14 10:00:00"
      },
      {
        "id": 10002,
        "${f.str}": "TEST_DATA_002",
        "${f.num}": ${Math.floor(Math.random() * 1000)},
        "status": 0,
        "${f.date}": "2026-01-14 11:30:00"
      }
    ]
  }
}`;
        }
        if (actionType === 'detail') {
            return `{
  "code": 200,
  "msg": "success",
  "data": {
    "id": 123456,
    "${f.str}": "Detail_Info_Block",
    "${f.num}": 99.99,
    "remark": "Production Data Structure",
    "createBy": "admin",
    "${f.date}": "2026-01-14 14:20:00"
  }
}`;
        }
        return `{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": true,
  "traceId": "0a${Math.random().toString(16).substr(2, 8)}"
}`;
    }

    function generateParams(actionType) {
        if (actionType === 'list') {
            return `
            <tr><td>pageNum</td><td>Integer</td><td class="req">æ˜¯</td><td>é¡µç </td></tr>
            <tr><td>pageSize</td><td>Integer</td><td class="req">æ˜¯</td><td>æ¡æ•°</td></tr>
            <tr><td>keyword</td><td>String</td><td>å¦</td><td>æœç´¢å…³é”®å­—</td></tr>
            <tr><td>startTime</td><td>String</td><td>å¦</td><td>å¼€å§‹æ—¶é—´</td></tr>`;
        }
        if (actionType === 'detail') {
            return `<tr><td>id</td><td>Long</td><td class="req">æ˜¯</td><td>ä¸»é”®ID</td></tr>`;
        }
        return `<tr><td colspan="4" style="text-align:center;color:#999">Body JSON å‚æ•°è§ä¸‹æ–‡</td></tr>`;
    }

    // ========================================================================
    // 3. UI æ¸²æŸ“é€»è¾‘
    // ========================================================================
    function createOverlay() {
        overlay = document.createElement('div');
        overlay.id = "moyu-knife";
        
        let menuHtml = '';
        let mainHtml = `<div class="doc-info">
            <h1 style="font-size:24px;margin-bottom:10px;">Enterprise API Documentation</h1>
            <div class="meta">
                <span>Version: 4.2.0-RELEASE</span>
                <span>Env: <b style="color:#52c41a">PROD</b></span>
                <span>Update: 2026-01-14</span>
            </div>
            <div style="margin-top:15px;font-size:12px;color:#666;">
                Generated by Swagger. Internal use only. Unauthorized access is prohibited.
            </div>
        </div>`;

        MODULES.forEach((mod, modIdx) => {
            const activeClass = modIdx === 0 ? 'active' : '';
            menuHtml += `<div class="menu-item ${activeClass}" data-target="group-${modIdx}">${mod.name}</div>`;
            
            let apisHtml = '';
            mod.nouns.forEach(noun => {
                const count = 2 + Math.floor(Math.random() * 3);
                const shuffledActions = ACTIONS.sort(() => 0.5 - Math.random()).slice(0, count);

                shuffledActions.forEach(act => {
                    const path = `${mod.prefix}/${noun}/${act.suffix}`; 
                    apisHtml += `
                        <div class="api-card">
                            <div class="api-head">
                                <span class="badge ${act.method}">${act.method}</span>
                                <span class="path">${path}</span>
                                <span class="desc">${noun} - ${act.desc}</span>
                            </div>
                            <div class="api-body">
                                <div class="section-title">Request Headers</div>
                                <table class="param-table">
                                    <tr><th>Header</th><th>Value</th><th>Required</th></tr>
                                    <tr><td>Authorization</td><td>Bearer {token}</td><td class="req">YES</td></tr>
                                </table>

                                <div class="section-title">Parameters</div>
                                <table class="param-table">
                                    <tr><th>Name</th><th>Type</th><th>Required</th><th>Description</th></tr>
                                    ${generateParams(act.type)}
                                </table>

                                ${act.type === 'form' ? `
                                <div class="section-title">Request Body</div>
                                <div class="code-box">{
  "remark": "string",
  "status": 1
}</div>` : ''}

                                <div class="section-title">Response</div>
                                <div class="code-box">${generateResponse(mod, act.type)}</div>
                            </div>
                        </div>
                    `;
                });
            });

            mainHtml += `
                <div id="group-${modIdx}" class="group-wrap">
                    <div class="group-title">${mod.name}</div>
                    ${apisHtml}
                </div>
            `;
        });

        overlay.innerHTML = STYLES + `
            <div class="sidebar">
                <div class="sidebar-logo">API Reference</div>
                <div class="menu-list">${menuHtml}</div>
            </div>
            <div class="main-content">
                ${mainHtml}
            </div>
        `;

        (document.documentElement || document.body).appendChild(overlay);
        bindEvents(overlay);
    }

    function bindEvents(el) {
        el.querySelector('.menu-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('menu-item')) {
                el.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                e.target.classList.add('active');
                const target = document.getElementById(e.target.dataset.target);
                if(target) target.scrollIntoView({behavior: 'smooth', block: 'start'});
            }
        });

        el.querySelector('.main-content').addEventListener('click', (e) => {
            const head = e.target.closest('.api-head');
            if (head) head.parentElement.classList.toggle('open');
        });

        el.addEventListener('wheel', e => e.stopPropagation(), {passive: false});
        el.addEventListener('keydown', e => e.stopPropagation());
        el.addEventListener('keyup', e => e.stopPropagation());
        el.addEventListener('click', () => { if(document.body) document.body.focus(); });
    }

    // ========================================================================
    // 4. æ ·å¼è¡¨
    // ========================================================================
    const STYLES = `
        <style>
            #moyu-knife {
                font-family: -apple-system, "Helvetica Neue", Arial, sans-serif;
                background: #f0f2f5; color: #333;
                width: 100vw; height: 100vh;
                position: fixed; top: 0; left: 0;
                z-index: 2147483647 !important;
                display: none; display: flex; font-size: 14px;
            }
            .sidebar { width: 260px; background: #001529; color: #a6adb4; display: flex; flex-direction: column; box-shadow: 2px 0 8px 0 rgba(29,35,41,.05); }
            .sidebar-logo { height: 64px; line-height: 64px; padding-left: 24px; font-weight: 600; color: #fff; font-size: 20px; background: #002140; }
            .menu-list { flex: 1; overflow-y: auto; padding-top: 10px; }
            .menu-item { padding: 12px 24px; cursor: pointer; transition: all 0.3s; margin-bottom: 4px; }
            .menu-item:hover { color: #fff; }
            .menu-item.active { background-color: #1890ff; color: #fff; }

            .main-content { flex: 1; overflow-y: auto; padding: 24px; scroll-behavior: smooth; }
            .doc-info { background: #fff; padding: 24px; margin-bottom: 24px; }
            .meta span { background: #f5f5f5; padding: 2px 8px; border-radius: 4px; color: #666; font-size: 12px; margin-right: 10px; }

            .group-wrap { margin-bottom: 40px; }
            .group-title { font-size: 20px; margin-bottom: 16px; padding-left: 10px; border-left: 4px solid #1890ff; font-weight: 500; }

            .api-card { background: #fff; margin-bottom: 12px; border: 1px solid #e8e8e8; border-radius: 2px; }
            .api-head { padding: 12px 16px; cursor: pointer; display: flex; align-items: center; background: #fafafa; transition: 0.2s; }
            .api-head:hover { background: #f0f7ff; }
            .api-card.open .api-head { border-bottom: 1px solid #e8e8e8; background: #e6f7ff; }
            .api-body { display: none; padding: 24px; }
            .api-card.open .api-body { display: block; }

            .badge { padding: 2px 8px; border-radius: 3px; color: #fff; font-weight: bold; font-size: 11px; margin-right: 10px; min-width: 50px; text-align: center; }
            .GET { background: #096dd9; }
            .POST { background: #52c41a; }
            .DELETE { background: #ff4d4f; }

            .path { font-family: Consolas, monospace; font-weight: 600; font-size: 15px; margin-right: 15px; flex: 1; }
            .desc { color: #999; font-size: 13px; }
            .section-title { font-weight: bold; margin: 15px 0 10px; font-size: 13px; border-left: 3px solid #ddd; padding-left: 8px; }
            .code-box { background: #282c34; color: #dcdfe4; padding: 15px; border-radius: 4px; font-family: Consolas, monospace; white-space: pre-wrap; font-size: 12px; }
            
            .param-table { width: 100%; border-collapse: collapse; font-size: 13px; }
            .param-table th { background: #fafafa; text-align: left; padding: 8px; border: 1px solid #e8e8e8; color: #666; }
            .param-table td { padding: 8px; border: 1px solid #e8e8e8; }
            .req { color: red; }
            
            ::-webkit-scrollbar { width: 8px; height: 8px; }
            ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
            ::-webkit-scrollbar-track { background: transparent; }
        </style>
    `;

    // ========================================================================
    // 5. æŒ‰é”®ç›‘å¬
    // ========================================================================
    function toggle() {
        if (!overlay) createOverlay();
        if (overlay.style.display === 'none') {
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            if(document.body) {
                if(!document.body.getAttribute('tabindex')) document.body.setAttribute('tabindex', '-1');
                document.body.focus();
                document.body.style.outline = 'none';
            }
        } else {
            overlay.style.display = 'none';
            document.body.style.overflow = '';
        }
    }

    let ctrlTapCount = 0;
    let ctrlTimer = null;
    let otherKeyPressed = false;

    document.addEventListener('keydown', (e) => {
        if (e.key !== 'Control') {
            otherKeyPressed = true;
            ctrlTapCount = 0;
        } else if (!e.repeat) {
            otherKeyPressed = false;
        }
        if (e.key === 'Escape' && overlay && overlay.style.display === 'flex') toggle();
    }, false);

    document.addEventListener('keyup', (e) => {
        if (e.key === 'Control') {
            if (otherKeyPressed) { ctrlTapCount = 0; return; }
            ctrlTapCount++;
            if (ctrlTapCount === 2) { toggle(); ctrlTapCount = 0; }
            clearTimeout(ctrlTimer);
            ctrlTimer = setTimeout(() => { ctrlTapCount = 0; }, 350);
        }
    }, false);

})();
